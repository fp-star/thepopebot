# GitHub Actions Workflow for Code Quality Checks
# Place in: .github/workflows/quality.yml

name: Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  # JavaScript/TypeScript Quality Checks
  javascript-quality:
    name: JavaScript/TypeScript Quality
    runs-on: ubuntu-latest
    if: |
      contains(github.event.head_commit.modified, '.js') ||
      contains(github.event.head_commit.modified, '.ts') ||
      contains(github.event.head_commit.modified, '.jsx') ||
      contains(github.event.head_commit.modified, '.tsx')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Full history for better analysis
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Lint
        run: npm run lint
      
      - name: Type check
        run: npm run type-check
        if: hashFiles('tsconfig.json') != ''
      
      - name: Format check
        run: npm run format:check
      
      - name: Complexity analysis
        run: npm run complexity || true
      
      - name: Duplication detection
        run: npm run duplication || true
      
      - name: Run tests with coverage
        run: npm run test:coverage
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: javascript
          name: javascript-coverage
      
      - name: Check coverage threshold
        run: |
          COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "❌ Coverage below 80%"
            exit 1
          else
            echo "✅ Coverage meets threshold"
          fi
      
      - name: Archive coverage report
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: coverage/

  # Python Quality Checks
  python-quality:
    name: Python Quality
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.modified, '.py')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements-dev.txt
      
      - name: Lint with flake8
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --statistics
      
      - name: Lint with pylint
        run: pylint src/ --exit-zero
      
      - name: Type check with mypy
        run: mypy src/
      
      - name: Format check with black
        run: black --check .
      
      - name: Import order check
        run: isort --check-only .
      
      - name: Security check with bandit
        run: bandit -r src/
      
      - name: Run tests with coverage
        run: pytest --cov=src --cov-report=xml --cov-report=html --cov-report=term
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: python
          name: python-coverage
      
      - name: Archive coverage report
        uses: actions/upload-artifact@v3
        with:
          name: python-coverage-report
          path: htmlcov/

  # Security Scanning
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'
      
      - name: GitLeaks scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Dependency vulnerability scan (Node.js)
        if: hashFiles('package.json') != ''
        run: |
          npm audit --audit-level=moderate
      
      - name: Dependency vulnerability scan (Python)
        if: hashFiles('requirements.txt') != ''
        run: |
          pip install safety
          safety check
      
      - name: Snyk vulnerability scan
        uses: snyk/actions/node@master
        if: hashFiles('package.json') != ''
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

  # SonarCloud Analysis
  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Shallow clones disabled for better analysis
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests with coverage
        run: npm run test:coverage
      
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=${{ github.repository_owner }}
            -Dsonar.projectKey=${{ github.repository }}
            -Dsonar.sources=src
            -Dsonar.tests=tests
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.coverage.exclusions=**/*.test.js,**/*.spec.js

  # Quality Gate Check
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [javascript-quality, python-quality, security-scan, sonarcloud]
    if: always()
    
    steps:
      - name: Check job results
        run: |
          echo "JavaScript Quality: ${{ needs.javascript-quality.result }}"
          echo "Python Quality: ${{ needs.python-quality.result }}"
          echo "Security Scan: ${{ needs.security-scan.result }}"
          echo "SonarCloud: ${{ needs.sonarcloud.result }}"
          
          if [[ "${{ needs.javascript-quality.result }}" == "failure" ]] ||
             [[ "${{ needs.python-quality.result }}" == "failure" ]] ||
             [[ "${{ needs.security-scan.result }}" == "failure" ]] ||
             [[ "${{ needs.sonarcloud.result }}" == "failure" ]]; then
            echo "❌ Quality gate failed"
            exit 1
          else
            echo "✅ Quality gate passed"
          fi
      
      - name: Post comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ All quality checks passed! Ready for review.'
            })
